<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ë ¥ê´€ì œ ì¥ì• ë³´ê³ ì„œ ë·°ì–´</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .header-container {
            text-align: center;
            margin-bottom: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .logo-img {
            max-height: 80px;
            margin-bottom: 15px;
        }

        .search-container {
            max-width: 800px;
            margin: 0 auto 30px auto;
        }

        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background-color: #f1f1f1;
        }

        .modal-header {
            background-color: #343a40;
            color: white;
        }

        .risk-high {
            color: #dc3545;
            font-weight: bold;
        }

        .risk-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .risk-low {
            color: #28a745;
            font-weight: bold;
        }

        /* ëª¨ë‹¬ í…Œì´ë¸” ì…€ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ */
        #detailModal td {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            body * {
                visibility: hidden;
            }

            #detailModal,
            #detailModal * {
                visibility: visible;
            }

            #detailModal .modal-dialog {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }

            #detailModal .modal-header,
            #detailModal .modal-footer {
                display: none !important;
            }

            #detailModal .modal-content {
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- í—¤ë” & ë¡œê³  -->
        <div class="header-container">
            <img src="io.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
            <h2 class="mt-2">ì¥ì• ë³´ê³ ì„œ í˜¸ì¶œê¸°</h2>
            <p class="text-muted">ê³¼ê±° ì¥ì•  ì´ë ¥ì„ ê²€ìƒ‰í•˜ê³  ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>

        <!-- ê²€ìƒ‰ì°½ -->
        <div class="search-container">
            <div class="input-group input-group-lg">
                <input type="text" id="searchInput" class="form-control" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ êµ¬ë¶„í•˜ì—¬ AND ê²€ìƒ‰)">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="searchBtn">ê²€ìƒ‰</button>
                </div>
            </div>
            <small class="form-text text-muted text-center mt-2">
                íŒ: ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ë©´ ì „ì²´ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </small>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div class="table-container" id="resultContainer">
            <h5 class="mb-3">ê²€ìƒ‰ ê²°ê³¼: <span id="resultCount">0</span>ê±´</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th data-sort="id" data-label="ìˆœë²ˆ">ìˆœë²ˆ</th>
                            <th data-sort="fault_datetime" data-label="ì¥ì• ì¼ì‹œ">ì¥ì• ì¼ì‹œ â–¼</th>
                            <th data-sort="fault_type" data-label="ì¥ì• ëª…">ì¥ì• ëª…</th>
                            <th data-sort="location" data-label="ì¥ì•  ì¥ì†Œ">ì¥ì•  ì¥ì†Œ</th>
                            <th data-sort="cause" data-label="ì¥ì•  ì›ì¸">ì¥ì•  ì›ì¸</th>
                            <th data-sort="risk_level" data-label="Risk">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="faultsTableBody">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal fade" id="detailModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">ì¥ì•  ìƒì„¸ ì •ë³´</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th style="width: 20%;" class="bg-light">ì¥ì• ëª…</th>
                                <td id="modalFaultType"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">ë°œìƒì¼ì‹œ</th>
                                <td id="modalDateTime"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">ì¥ì†Œ</th>
                                <td id="modalLocation"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">ì›ì¸</th>
                                <td id="modalCause"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">í˜„ìƒ</th>
                                <td id="modalSymptom"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">ì¡°ì¹˜ë°©ë²•</th>
                                <td id="modalAction"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="card mt-3">
                        <div class="card-header bg-light font-weight-bold">
                            ì›ë³¸ í…ìŠ¤íŠ¸
                        </div>
                        <div class="card-body">
                            <pre id="modalRawText"
                                style="white-space: pre-wrap; background-color: #f8f9fa; padding: 10px; border-radius: 5px;"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="printReport()">ğŸ–¨ï¸ ì¸ì‡„</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        let allFaults = [];
        let currentSort = { column: 'fault_datetime', order: 'desc' };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        window.onload = async function () {
            try {
                const res = await fetch('/api/faults');
                allFaults = await res.json();
                console.log(`Loaded ${allFaults.length} faults.`);

                // í—¤ë”ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                document.querySelectorAll('th[data-sort]').forEach(th => {
                    th.style.cursor = 'pointer';
                    th.addEventListener('click', () => {
                        const column = th.dataset.sort;
                        handleSort(column);
                    });
                });
            } catch (e) {
                console.error('Data load failed:', e);
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e);
            }
        };

        // ì •ë ¬ ì²˜ë¦¬
        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'desc';
            }
            updateSortUI();
            performSearch();
        }

        function updateSortUI() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.innerHTML = th.dataset.label;
                if (th.dataset.sort === currentSort.column) {
                    const arrow = currentSort.order === 'asc' ? ' â–²' : ' â–¼';
                    th.innerHTML += arrow;
                }
            });
        }

        // ê²€ìƒ‰ ë¡œì§
        function performSearch() {
            const input = document.getElementById('searchInput').value;
            let results = [];

            // ì™„ì „íˆ ë¹ˆ ë¬¸ìì—´: ìˆ¨ê¹€, ê³µë°±ë§Œ: ì „ì²´ í‘œì‹œ
            if (input === '') {
                results = [];
            } else if (input.trim() === '') {
                // ê³µë°±ë§Œ ì…ë ¥ëœ ê²½ìš° ì „ì²´ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                results = [...allFaults];
            } else {
                const keywords = input.trim().split(/\s+/).filter(k => k.length > 0);
                results = allFaults.filter(fault => {
                    const target = (fault.fault_type || '').toLowerCase();
                    return keywords.every(k => target.includes(k.toLowerCase()));
                });
            }

            // ì •ë ¬
            results.sort((a, b) => {
                let valA = a[currentSort.column] || '';
                let valB = b[currentSort.column] || '';

                if (currentSort.column === 'id') {
                    valA = parseInt(valA);
                    valB = parseInt(valB);
                }

                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(results);
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            const tbody = document.getElementById('faultsTableBody');
            const container = document.getElementById('resultContainer');
            const countSpan = document.getElementById('resultCount');

            tbody.innerHTML = '';
            countSpan.textContent = data.length;

            if (data.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'clickable-row';
                tr.onclick = () => showDetail(item.id);

                let riskClass = '';
                if (item.risk_level === 'High') riskClass = 'risk-high';
                else if (item.risk_level === 'Medium') riskClass = 'risk-medium';
                else if (item.risk_level === 'Low') riskClass = 'risk-low';

                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.fault_datetime}</td>
                    <td class="font-weight-bold">${item.fault_type}</td>
                    <td>${item.location || '-'}</td>
                    <td>${item.cause || '-'}</td>
                    <td class="${riskClass}">${item.risk_level || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ìƒì„¸ ì •ë³´ ë³´ê¸°
        async function showDetail(id) {
            try {
                const res = await fetch(`/api/faults/${id}`);
                if (!res.ok) throw new Error('ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');

                const data = await res.json();

                document.getElementById('modalTitle').textContent = `[${data.id}] ${data.fault_type}`;
                document.getElementById('modalFaultType').innerHTML = data.fault_type || '-';
                document.getElementById('modalDateTime').innerHTML = data.fault_datetime || '-';
                document.getElementById('modalLocation').innerHTML = (data.location || '-').replace(/\n/g, '<br>');
                document.getElementById('modalCause').innerHTML = (data.cause || '-').replace(/\n/g, '<br>');
                document.getElementById('modalSymptom').innerHTML = (data.symptom || '-').replace(/\n/g, '<br>');
                document.getElementById('modalAction').innerHTML = (data.action || '-').replace(/\n/g, '<br>');
                document.getElementById('modalRawText').textContent = data.raw_text || 'ì›ë³¸ í…ìŠ¤íŠ¸ ì—†ìŒ';

                $('#detailModal').modal('show');
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e);
            }
        }

        // ì¸ì‡„ í•¨ìˆ˜
        function printReport() {
            window.print();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('searchInput').addEventListener('input', performSearch);
    </script>
</body>

</html>